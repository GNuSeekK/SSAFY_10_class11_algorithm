http://k10a606.p.ssafy.io:9090/project/bespo-deploy-be
f399e902b5c1d1356793384e7f94d26c

scp -v -o StrictHostKeyChecking=no -i /var/jenkins_home/bespo-deploy-be.pem /var/jenkins_home/workspace/bespo-deploy-be/build/libs/bespo-deploy-be-0.0.1-SNAPSHOT.jar ubuntu@k10a606.p.ssafy.io:/home/ubuntu/app-server

#bin/bash

#docker hup에서 pull 하기 위해 login
sudo docker login -u hyeseungS -p gptmd0512!

#tag를 지정하지 않고 pull 하여 docker hub에서 latest를 가져온다.
sudo docker pull hyeseungS/bespo

#이전에 사용 중이던 서버를 종료
#MyDiary.jar은 Dockfile에 ADD의 이름을 넣어주면 됩니다.
kill -9 $(ps aux | grep java | grep MyDiary.jar| awk '{print $2}')

#docker run을 통해 image를 실행
#-d : 백그라운드 실행, --rm : 컨테이너 안의 프로세스가 종료되면 컨테이너를 자동>으로 삭제, -p 80번 포트 열기
sudo docker run -d --rm -p 8080:8080 <docker id>/<docker Repository>

IMAGE_NAME=app_server
TAG_ID=$(docker images | sort -r -k2 -h | grep "${IMAGE_NAME}" | awk 'BEGIN{tag = 1} NR==1{tag += $2} END{print tag}')
 
echo "> 도커 build 실행 : docker build --build-arg IDLE_PROFILE=${IDLE_PROFILE} -t ${IMAGE_NAME}:${TAG_ID} ."
docker build --build-arg IDLE_PROFILE=${IDLE_PROFILE} -t ${IMAGE_NAME}:${TAG_ID} /home/ubuntu/app-server
 
echo "> $IDLE_PROFILE 배포"
echo "> 도커 run 실행 :  sudo docker run --name $IDLE_PROFILE -d --rm -p $IDLE_PORT:${IDLE_PORT} ${IMAGE_NAME}:${TAG_ID}"
docker run --name $IDLE_PROFILE -d --rm -p $IDLE_PORT:${IDLE_PORT} ${IMAGE_NAME}:${TAG_ID}
 