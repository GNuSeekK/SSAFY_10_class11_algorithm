57ba64a87dd82f5a252ab30cf265755c
pipeline { 
    tools {
        gradle 'gradle'
    }
    environment { 
        repository = "hyeseungs/bespo"  
        DOCKERHUB_CREDENTIALS = credentials('docker-hub-token')
        dockerImage = '' 
    }
    agent any 
    stages { 
        stage('Git clone') {
            steps {
                git branch: 'dev/back', credentialsId: 'gitlab', url: 'https://lab.ssafy.com/s10-final/S10P31A606.git'
            }
        }
        
        stage('Replace Properties') {
            steps {
                script {
                    withCredentials([file(credentialsId: 'dev-secret-file', variable: 'secret-file')]) {
                        sh 'cp $secret-file' './src/main/resources/application.properties'
                    }
                }
            }
        }
        
        stage('Build backend dev') {
            steps {
                dir('backend') {
                    sh "chmod +x gradlew"
                    sh "./gradlew clean bootJar"
                }
            }
        }
        
        stage('Building our image') { 
            steps { 
                script { 
                    sh "cp /var/jenkins_home/workspace/Bespo-Dev-BE/backend/build/libs/bespo-0.0.1-SNAPSHOT.jar /var/jenkins_home/workspace/Bespo-Dev-BE/"
                    dockerImage = docker.build repository + ":$BUILD_NUMBER"
                }
            } 
        }
        stage('Login Dockerhub'){
            steps{
                sh 'echo $DOCKERHUB_CREDENTIALS_PSW | docker login -u $DOCKERHUB_CREDENTIALS_USR --password-stdin'
            }
        }
        stage('Push') {
            steps {
                sh 'docker push $repository:$BUILD_NUMBER'
            }
        }
        stage('Pull') {
            steps {
                sh 'docker pull $repository:$BUILD_NUMBER'
            }
        }
        stage('stop prev container') {
            steps {
                sh 'docker stop dev-back || true'
                sh 'docker rm dev-back || true'
            }
        }
        stage('Run') {
            steps {
                sh 'docker run -d -p 8081:8081 --name dev-back $repository:$BUILD_NUMBER'
            }
        }
    }
    post {
        always {
            sh 'docker logout'
        }
    }
}